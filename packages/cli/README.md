# @spfn/cli

SPFN CLI - The Missing Backend for Next.js

> Zero-configuration backend framework with Rails productivity + Spring Boot robustness

## Quick Start

```bash
cd your-nextjs-project
npx @spfn/cli init
npm run dev
```

That's it! Your backend is ready.

---

## Commands

### `spfn init`

Initialize SPFN in an existing Next.js project.

```bash
npx @spfn/cli init
```

**What it does:**

1. ✅ Installs dependencies (@spfn/core, hono, drizzle-orm, etc.)
2. ✅ Creates `src/server/` directory structure
3. ✅ Adds example routes and entities
4. ✅ Updates package.json scripts
5. ✅ Creates .env.local.example

**Options:**
- `-y, --yes` - Skip all prompts

---

### `spfn dev`

Start development server (Next.js + SPFN automatically).

```bash
npm run dev
# or
spfn dev
```

**Features:**
- 🔍 Auto-detects Next.js
- 🚀 Runs both Next.js (3000) + Hono (4000) servers
- 🔥 Hot reload for backend routes
- 📊 Colored output with process names

**Options:**
- `-p, --port <port>` - Server port (default: 4000)
- `-h, --host <host>` - Server host (default: localhost)
- `--server-only` - Run only Hono server (skip Next.js)

**Examples:**
```bash
spfn dev                    # Next.js + Hono
spfn dev --server-only      # Hono only
spfn dev -p 5000            # Custom port
```

---

### `spfn start`

Start production Hono server.

```bash
npm run start:server
# or
spfn start
```

**Options:**
- `-p, --port <port>` - Server port (default: 4000)
- `-h, --host <host>` - Server host (default: 0.0.0.0)

---

## Project Structure

**Zero Config (default):**
```
your-nextjs-project/
├── src/
│   ├── app/                      # Next.js
│   └── server/                   # SPFN (generated by init)
│       ├── routes/               # API routes (you write)
│       │   ├── health/
│       │   │   └── index.ts
│       │   └── users/
│       │       └── index.ts
│       ├── entities/             # Database entities (you write)
│       │   ├── users.ts
│       │   └── README.md
│       ├── app.example.ts        # Full customization example
│       └── server.config.example.ts  # Partial config example
└── package.json
```

**No `index.ts`, no `app.ts` needed!** Framework handles everything.

---

## Configuration Levels

### Level 1: Zero Config (Recommended)

Just write routes and entities. Everything else is automatic.

```typescript
// src/server/routes/users/index.ts
import type { RouteContext } from '@spfn/core';
import { getDb } from '@spfn/core';
import { users } from '../../entities/users.js';

export async function GET(c: RouteContext) {
    const db = getDb();
    const allUsers = await db.select().from(users);
    return c.json(allUsers);
}
```

**Run:** `npm run dev` - Done!

---

### Level 2: Partial Customization

Create `server.config.ts` for custom middleware/settings.

```typescript
// src/server/server.config.ts
import { Hono } from 'hono';
import { authMiddleware } from './middleware/auth.js';

export default async function configure(app: Hono) {
    // Add custom middleware
    app.use('/api/*', authMiddleware());

    // Return config
    return {
        port: 4000,
        cors: { origin: 'https://myapp.com' },
    };
}
```

---

## Generated Scripts

After `spfn init`:

```json
{
  "scripts": {
    "dev": "spfn dev",                    // Next.js + Hono
    "dev:next": "next dev",               // Next.js only
    "dev:server": "spfn dev --server-only", // Hono only
    "build": "next build",
    "start": "next start",
    "start:server": "spfn start"
  }
}
```

---

## How It Works

1. **`spfn dev` detects Next.js**
   - Checks package.json for `next` dependency
   - If found → Runs both `next dev` + SPFN server
   - If not found → Runs SPFN server only

2. **Zero configuration**
   - No entry point files needed
   - Framework auto-loads routes from `src/server/routes/`
   - Default middleware (logger, CORS, error handler) applied automatically

3. **Progressive enhancement**
   - Start with zero config
   - Add `server.config.ts` when you need customization
   - Full control available when needed

---

## Features

- 🚀 **Zero Config** - No boilerplate, just write routes
- 🎯 **Convention over Configuration** - Rails-like productivity
- 📁 **File-based Routing** - Next.js App Router style for backend
- 🔄 **Auto-reload** - Hot reload in development
- 🗄️ **Database Ready** - Drizzle ORM + Repository pattern
- 🔒 **Type-safe** - End-to-end TypeScript
- 📦 **Package Manager Agnostic** - npm, pnpm, yarn, bun

---

## Next Steps

After running `spfn init`:

1. **Configure database:**
   ```bash
   cp .env.local.example .env.local
   # Edit .env.local with your database URL
   ```

2. **Start development:**
   ```bash
   npm run dev
   ```

3. **Visit your API:**
   - Health check: http://localhost:4000/health
   - Example route: http://localhost:4000/examples

4. **Create your first route:**
   ```typescript
   // src/server/routes/hello/index.ts
   import type { RouteContext } from '@spfn/core';

   export async function GET(c: RouteContext) {
       return c.json({ message: 'Hello SPFN!' });
   }
   ```

---

## Requirements

- Node.js >= 18
- Next.js project (optional - works standalone too)

## Development Notes

### For Package Maintainers

**Template Path Resolution:**
- Uses dual path detection (`findTemplatesPath()`)
- npm package: `dist/templates/` (after build)
- Monorepo dev: `../templates/` (fallback)
- Ensures compatibility in both environments

**Publishing:**
- `workspace:*` dependencies auto-resolved by pnpm publish
- Templates copied to `dist/` during build
- Package size: ~9.4 KB

**Testing:**
```bash
# Build and test locally
npm run build
npm pack --dry-run

# Install in test project
cd /path/to/nextjs-project
npm install /path/to/spfn-cli-0.1.0.tgz
```

## License

MIT
